# Self-hosted Email Server Setup Guide

This guide helps you set up a completely self-hosted email server for your Dead Man's Switch application, eliminating the need for third-party services like SendGrid or AWS SES.

## 🎯 What This Setup Provides

- **Complete email server** with SMTP, IMAP, and webmail
- **Zero third-party dependencies** - no SendGrid, AWS, or other external services
- **Professional email features** - DKIM, SPF, DMARC for deliverability
- **Webmail interface** (Roundcube) for managing emails
- **Containerized solution** - easy to deploy and maintain
- **Security-focused** - TLS encryption, fail2ban, spam filtering

## 🏗️ Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Your App      │───▶│  Docker Mail     │───▶│   Recipients    │
│                 │    │  Server          │    │                 │
│ - Nodemailer    │    │ - Postfix (SMTP) │    │ - Gmail         │
│ - SMTP Client   │    │ - Dovecot (IMAP) │    │ - Yahoo         │
│                 │    │ - Roundcube      │    │ - Outlook       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 🚀 Quick Start

### Option 1: Automated Setup (Recommended)

```bash
# Run the automated setup script
cd /path/to/your/deadmansswitch
chmod +x scripts/setup-email-server.sh
./scripts/setup-email-server.sh
```

The script will:

1. Create all necessary directories
2. Configure email accounts
3. Start the email server
4. Generate DKIM keys
5. Provide DNS configuration instructions

### Option 2: Manual Setup

1. **Copy the email configuration:**

   ```bash
   cp apps/backend/environment.email apps/backend/.env.email
   # Edit the file with your domain and credentials
   ```

2. **Start the email server:**

   ```bash
   docker-compose -f docker-compose.email.yml up -d
   ```

3. **Create your first email account:**
   ```bash
   docker exec mailserver setup email add user@yourdomain.com password
   ```

## 📧 Configuring Your Application

### Environment Variables

Add these to your backend `.env` file:

```env
# Self-hosted SMTP Configuration
SMTP_HOST=mail.yourdomain.com
SMTP_PORT=587
SMTP_USER=noreply@yourdomain.com
SMTP_PASSWORD=your_secure_password
SMTP_SECURE=false
FROM_EMAIL=noreply@yourdomain.com

# Optional settings
SMTP_DEBUG=false
SMTP_REJECT_UNAUTHORIZED=true
```

### Testing Email Functionality

Your application will automatically use the self-hosted SMTP server once configured. The email service prioritizes:

1. **Self-hosted SMTP** (if SMTP_HOST is configured)
2. Third-party services (SendGrid, AWS)
3. Console logging (development mode)

## 🌐 DNS Configuration

**Critical**: Your email server requires proper DNS configuration. See [`scripts/email-dns-guide.md`](scripts/email-dns-guide.md) for detailed instructions.

### Quick DNS Checklist

- [ ] MX record: `yourdomain.com` → `mail.yourdomain.com`
- [ ] A record: `mail.yourdomain.com` → `YOUR_SERVER_IP`
- [ ] SPF record: `v=spf1 mx ~all`
- [ ] DMARC record: `v=DMARC1; p=quarantine; rua=mailto:admin@yourdomain.com`
- [ ] DKIM record: (generated by the email server)

## 🔒 Security Features

### Built-in Security

- **TLS/SSL encryption** for all connections
- **DKIM signing** for email authentication
- **SPF/DMARC** policies for sender verification
- **Fail2ban** to block malicious IPs
- **Spam filtering** with Rspamd
- **Virus scanning** with ClamAV

### Firewall Configuration

Open these ports on your server:

```bash
# SMTP (encrypted)
ufw allow 587/tcp
# IMAP (encrypted)
ufw allow 993/tcp
# Optional: HTTP for Roundcube
ufw allow 8080/tcp
```

## 🔧 Management and Maintenance

### Common Commands

```bash
# View email server logs
docker-compose -f docker-compose.email.yml logs -f

# Add a new email account
docker exec mailserver setup email add newuser@yourdomain.com password

# List email accounts
docker exec mailserver setup email list

# Restart the email server
docker-compose -f docker-compose.email.yml restart

# Update email server
docker-compose -f docker-compose.email.yml pull
docker-compose -f docker-compose.email.yml up -d
```

### Webmail Access

Access Roundcube webmail at: `http://your-server-ip:8080`

Login with any email account you created.

### Monitoring Email Delivery

1. **Check logs:**

   ```bash
   docker exec mailserver tail -f /var/log/mail/mail.log
   ```

2. **Test email delivery:**

   ```bash
   docker exec mailserver setup debug login user@yourdomain.com
   ```

3. **DMARC reports:** Monitor the email address specified in your DMARC record

## 📊 Email Deliverability

### Improving Deliverability

1. **Warm up your IP**: Start with low email volumes
2. **Monitor reputation**: Use tools like [Sender Score](https://www.senderscore.org/)
3. **Handle bounces**: Remove invalid email addresses promptly
4. **Maintain lists**: Keep your email lists clean and engaged

### Testing Tools

- [MXToolbox](https://mxtoolbox.com/) - Check DNS and deliverability
- [Mail-tester](https://www.mail-tester.com/) - Score your email setup
- [DMARC Analyzer](https://www.dmarcanalyzer.com/) - Monitor DMARC reports

## 🐛 Troubleshooting

### Common Issues

1. **Emails not sending:**

   - Check DNS configuration
   - Verify firewall settings
   - Review email server logs

2. **Emails going to spam:**

   - Ensure proper DNS records (SPF, DKIM, DMARC)
   - Check server reputation
   - Warm up your IP address

3. **Cannot connect to SMTP:**
   - Verify SMTP_HOST and credentials
   - Check network connectivity
   - Review TLS/SSL settings

### Debug Mode

Enable debug mode for troubleshooting:

```env
SMTP_DEBUG=true
```

This will show detailed SMTP communication in your application logs.

## 💡 Alternative Solutions

### For Development/Testing

1. **MailHog** (catches all emails):

   ```bash
   docker run -p 1025:1025 -p 8025:8025 mailhog/mailhog
   ```

   Configure: `SMTP_HOST=localhost SMTP_PORT=1025`

2. **Mailtrap** (third-party testing):
   ```bash
   # Configure with Mailtrap credentials
   SMTP_HOST=smtp.mailtrap.io
   SMTP_PORT=587
   ```

### For Production Alternatives

If you need a simpler self-hosted solution:

1. **Postal** - Modern mail server
2. **iRedMail** - Full-featured mail server
3. **Mail-in-a-Box** - Easy setup for non-technical users

## 🔄 Backup and Recovery

### Backup Email Data

```bash
# Backup email data
tar -czf email-backup-$(date +%Y%m%d).tar.gz docker-data/dms/

# Backup configuration
tar -czf email-config-backup-$(date +%Y%m%d).tar.gz docker-data/dms/config/
```

### Restore Email Data

```bash
# Stop email server
docker-compose -f docker-compose.email.yml down

# Restore data
tar -xzf email-backup-YYYYMMDD.tar.gz

# Start email server
docker-compose -f docker-compose.email.yml up -d
```

## 📈 Scaling Considerations

### For High Volume

1. **Multiple servers**: Use multiple SMTP servers with load balancing
2. **Queue management**: Implement email queues for reliability
3. **Rate limiting**: Configure appropriate sending limits
4. **Monitoring**: Set up monitoring for server health and delivery rates

### Resource Requirements

- **Minimum**: 1 CPU, 1GB RAM, 20GB storage
- **Recommended**: 2 CPU, 2GB RAM, 50GB storage
- **High volume**: 4+ CPU, 4GB+ RAM, 100GB+ storage

## ⚡ Performance Optimization

1. **Email queues**: Use Redis or database queues for batch processing
2. **Connection pooling**: Enable in nodemailer configuration
3. **Rate limiting**: Implement sending limits to avoid blacklisting
4. **Monitoring**: Track email delivery success rates

## 🆘 Support and Resources

- [Docker Mailserver Documentation](https://docker-mailserver.github.io/docker-mailserver/latest/)
- [Nodemailer Documentation](https://nodemailer.com/about/)
- [Email Deliverability Guide](https://sendgrid.com/blog/email-deliverability-guide/)

---

## ✅ Setup Checklist

- [ ] Run setup script or manual configuration
- [ ] Configure DNS records (MX, A, SPF, DMARC, DKIM)
- [ ] Update application environment variables
- [ ] Test email sending functionality
- [ ] Configure firewall rules
- [ ] Set up monitoring and backups
- [ ] Test email deliverability with major providers

**🎉 Congratulations!** You now have a completely self-hosted email solution that doesn't rely on any third-party services!
