# DNS Configuration for Self-hosted Email Server

This guide helps you configure DNS records for your self-hosted email server to ensure proper email delivery and security.

## Required DNS Records

### 1. MX Record (Mail Exchange)

Points your domain to your mail server.

```
Type: MX
Name: @ (or your domain)
Value: mail.yourdomain.com
Priority: 10
TTL: 3600
```

### 2. A Record (Address Record)

Points your mail subdomain to your server's IP address.

```
Type: A
Name: mail
Value: YOUR_SERVER_IP_ADDRESS
TTL: 3600
```

### 3. SPF Record (Sender Policy Framework)

Prevents email spoofing by specifying which servers can send email for your domain.

```
Type: TXT
Name: @ (or your domain)
Value: v=spf1 mx ~all
TTL: 3600
```

**Explanation:**

- `v=spf1`: SPF version 1
- `mx`: Allow servers listed in MX records to send email
- `~all`: Soft fail for all other servers (recommended for testing)
- Use `~all` for production after testing

### 4. DMARC Record (Domain-based Message Authentication)

Provides instructions for handling emails that fail SPF or DKIM checks.

```
Type: TXT
Name: _dmarc
Value: v=DMARC1; p=quarantine; rua=mailto:admin@yourdomain.com
TTL: 3600
```

**Explanation:**

- `v=DMARC1`: DMARC version 1
- `p=quarantine`: Quarantine emails that fail authentication (start with this)
- `rua=mailto:admin@yourdomain.com`: Send aggregate reports to this address
- Use `p=reject` in production after testing

### 5. DKIM Record (DomainKeys Identified Mail)

Adds a digital signature to verify email authenticity.

The DKIM record is automatically generated by docker-mailserver. Get it by running:

```bash
docker exec mailserver cat /tmp/docker-mailserver/opendkim/keys/yourdomain.com/mail.txt
```

It will look like:

```
Type: TXT
Name: mail._domainkey
Value: v=DKIM1; h=sha256; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQE...
TTL: 3600
```

## DNS Configuration Examples

### Cloudflare

1. Go to your domain in Cloudflare Dashboard
2. Click "DNS" tab
3. Add each record type with the values above
4. Make sure the mail.yourdomain.com A record is **not** proxied (gray cloud)

### Namecheap

1. Go to "Domain List" → "Manage" → "Advanced DNS"
2. Add each record type with the values above
3. Wait for propagation (up to 48 hours)

### GoDaddy

1. Go to "DNS Management" for your domain
2. Add each record type with the values above
3. Use "@" for the root domain in Name field

## Testing Your DNS Configuration

### Check MX Record

```bash
dig MX yourdomain.com
```

### Check SPF Record

```bash
dig TXT yourdomain.com | grep spf1
```

### Check DMARC Record

```bash
dig TXT _dmarc.yourdomain.com
```

### Check DKIM Record

```bash
dig TXT mail._domainkey.yourdomain.com
```

### Online Tools

- [MXToolbox](https://mxtoolbox.com/) - Comprehensive email testing
- [SPF Record Checker](https://www.kitterman.com/spf/validate.html)
- [DMARC Analyzer](https://www.dmarcanalyzer.com/dmarc-checker/)

## Reverse DNS (PTR Record)

If you control your server's IP address, set up reverse DNS:

```
Type: PTR
IP: YOUR_SERVER_IP
Value: mail.yourdomain.com
```

**Note:** This is usually configured through your hosting provider or VPS provider.

## SSL/TLS Certificate

For production, use Let's Encrypt certificates:

1. Install Certbot on your server
2. Get certificates for your mail domain:
   ```bash
   certbot certonly --standalone -d mail.yourdomain.com
   ```
3. Update docker-compose.email.yml to use the certificates

## Troubleshooting

### DNS Propagation

- DNS changes can take up to 48 hours to propagate globally
- Use different DNS checkers to verify propagation
- Test from different locations

### Common Issues

1. **MX priority**: Use priority 10 for single mail server
2. **SPF includes**: Don't include unnecessary services
3. **DKIM key**: Ensure the key is properly formatted (no extra spaces)
4. **Reverse DNS**: Many providers block emails without proper reverse DNS

### Email Deliverability Testing

1. Send test emails to major providers (Gmail, Yahoo, Outlook)
2. Check spam folders
3. Use online tools to test your email reputation
4. Monitor DMARC reports for authentication failures

## Security Best Practices

1. **Start with soft policies**: Use `~all` for SPF and `p=quarantine` for DMARC
2. **Monitor reports**: Review DMARC aggregate reports regularly
3. **Rotate DKIM keys**: Consider rotating DKIM keys annually
4. **Regular testing**: Test email deliverability monthly
5. **Backup configurations**: Keep DNS configurations documented
